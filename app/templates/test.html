<!doctype html>
<head>
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='style.css') }}">
</head>

<title>{{ title }}</title>

<body>
    <div class="nav">
        <a href="/cashflow">Cash Flow</a>
        <a href="/portfolio">Portfolio Metrics</a>
        <a href="/test">Optimisation & Backtesting</a>
    </div>

    <h1>{{ title }}</h1>
    
    <div class="chart-container">
        <div class="analysis-tabs">
            <div class="portfolio-tab portfolio-active-tab" data-mode="returns">Log Returns</div>
            <div class="portfolio-tab" data-mode="heatmap">Correlation</div>
        </div>
     
        <div id="history-controls">
            <label for="start-date">Missing data? Backfill from:</label>
            <input type="date" id="start-date" name="start-date" style="font-size: 0.9em;">
            <button id="expand-btn" style="padding: 2px 8px; cursor: pointer; background: #007BFF; color: white; border: none; border-radius: 3px;">Expand</button>
        </div>
    
        <h2 id="portfolio-chart-title" style="margin: 0; padding:20px;"></h2>
        <div id="portfolio-plot-container">
        </div>
    </div>
    
    <div class="stats-page-layout"  style="padding-top: 20px">
        <div class="table-chart-container">
            <table id="ticker-sidebar-table">
                <thead>
                    <tr>
                        <th style="background-color: #007BFF; color: white; padding: 10px;">Tickers</th>
                    </tr>
                </thead>
                <tbody>
                    {% for t in tickers %}
                    <tr class="ticker-row {% if t == selected_ticker %}active-ticker{% endif %}" 
                        data-ticker="{{ t }}" 
                        style="cursor: pointer;">
                        <td>
                            <div style="display: flex; align-items: center; justify-content: space-between; padding: 5px;">
                                <b>{{ t }}</b>
                                <span class="indicator">{% if t == selected_ticker %}▶{% endif %}</span>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
                <tfoot>
                    <tr class="total-row">
                        <td>Total: {{ tickers|length }}</td>
                    </tr>
                </tfoot>
            </table>
        </div>

        <div class="chart-container">
            <div class="analysis-tabs">
                <div class="tab active-tab" data-mode="price">Price Chart</div>
                <div class="tab" data-mode="returns">Log Returns</div>
                <div class="tab" data-mode="map-2dcorr">2D correlation</div>
                <div class="tab" data-mode="sentiment">Sentiment (Soon)</div>
            </div>

        
            <h2 id="chart-title" style="margin: 0; padding:20px;">{{ selected_ticker }}</h2>
            <div id="price-plot-container">
            </div>
        </div>
    </div>
    
    <h2 style="padding-top: 10px">Metrics</h2>
    
    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>Sharpe</th>
                    <th>Semivariance</th>
                    <th>Sortino</th>
                    <th>Symmetry score</th>
                    <th>D'Agostino-Pearson statistics</th>
                    <th>D'Agostino-Pearson p-value</th>
                    <th>Jarque-Bera statistics</th>
                    <th>Jarque-Bera p-value</th>
                    <th>Z-score max</th>
                    <th>Z-score min</th>
                    <th>Number outliers</th>
                </td>
            </thead>
            
            <tbody>
                <tr>
                    <td>
                        <span id="sharpe-ratio-display">
                            {% if sharpe[selected_ticker] is defined %}
                                {{ "%.2e"|format(sharpe[selected_ticker]) }}
                            {% else %}
                                0.0
                            {% endif %}
                        </span>
                    </td>

                    <td>
                        <span id="semivariance-display">
                            {% if semivariance[selected_ticker] is defined %}
                                {{ "%.2e"|format(semivariance[selected_ticker]) }}
                            {% else %}
                                0.0
                            {% endif %}
                        </span>
                    </td>

                    <td>
                        <span id="sortino-ratio-display">
                            {% if sortino[selected_ticker] is defined %}
                                {{ "%.2e"|format(sortino[selected_ticker]) }}
                            {% else %}
                                0.0
                            {% endif %}
                        </span>
                    </td>

                    <td>
                        <span id="symmetry-score-display">
                            {% if symmetry_score is defined %}
                                {{ "%.2f"|format(symmetry_score) }}
                            {% else %}
                                0.0
                            {% endif %}
                        </span>%
                    </td>

                    <td>
                        <span id="dagostino_pearson_statistics-display">
                            {% if dagostino_pearson_statistics is defined %}
                                {{ "%.2f"|format(dagostino_pearson_statistics) }}
                            {% else %}
                                0.0
                            {% endif %}
                        </span>
                    </td>

                    <td>
                        <span id="dagostino_pearson_pvalue-display">
                            {% if dagostino_pearson_pvalue is defined %}
                                {{ "%.2e"|format(dagostino_pearson_pvalue) }}
                            {% else %}
                                0.0
                            {% endif %}
                        </span>
                    </td>

                    <td>
                        <span id="jarque_bera_statistics-display">
                            {% if jarque_bera_statistics is defined %}
                                {{ "%.2f"|format(jarque_bera_statistics) }}
                            {% else %}
                                0.0
                            {% endif %}
                        </span>
                    </td>

                    <td>
                        <span id="jarque_bera_pvalue-display">
                            {% if jarque_bera_pvalue is defined %}
                                {{ "%.2e"|format(jarque_bera_pvalue) }}
                            {% else %}
                                0.0
                            {% endif %}
                        </span>
                    </td>
                    
                    <td>
                        <span id="z_score_max-display">
                            {% if z_score_max is defined %}
                                {{ "%.2f"|format(z_score_max) }}
                            {% else %}
                                0.0
                            {% endif %}
                        </span>
                    </td>
                    
                    <td>
                        <span id="z_score_min-display">
                            {% if z_score_min is defined %}
                                {{ "%.2f"|format(z_score_min) }}
                            {% else %}
                                0.0
                            {% endif %}
                        </span>
                    </td>
                    
                    <td>
                        <span id="len_outliers-display">
                            {% if len_outliers is defined %}
                                {{ len_outliers }}
                            {% else %}
                                0
                            {% endif %}
                        </span>
                    </td>
                </tr>
            <tbdody>
        </table>

        
    </div>
    
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Portfolio variables
            let portfolioMode = "returns"; // Default portfolio mode
            const portfolioTabs = document.querySelectorAll('.portfolio-tab');
            
            // Tickers variables
            let currentTicker = "{{ selected_ticker }}";
            let secondaryTicker = "";
            let currentMode = "price"; // Default ticker mode
            const tabs = document.querySelectorAll('.tab');
            const tickerRows = document.querySelectorAll('.ticker-row');

            updateView();
            updatePortfolioView();
            
            // Portfolio logic
            function updatePortfolioView() {
                const container = document.getElementById('portfolio-plot-container');
                const title = document.getElementById('portfolio-chart-title');
                
                title.innerText = `${portfolioMode.toUpperCase()}`;

                // Fetching data for the whole portfolio
                fetch(`/get_portfolio_data?mode=${portfolioMode}`)
                    .then(res => res.json())
                    .then(data => {
                        if (portfolioMode === 'heatmap'){
                            Plotly.react(container, data.fig_data.data, data.fig_data.layout, { displayModeBar: false });
                        } else{
                            Plotly.react(container, data.fig_data.data, data.fig_data.layout);
                        }
                    })
                    .catch(err => console.error("Portfolio Plot Error:", err));
            }

            // Portfolio Tab Click Listener
            portfolioTabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    portfolioTabs.forEach(t => t.classList.remove('portfolio-active-tab'));
                    this.classList.add('portfolio-active-tab');
                    
                    portfolioMode = this.dataset.mode;
                    updatePortfolioView();
                });
            });
            
            // Individual ticker logic
            function updateView() {
                // Here we update the fetch URL to include the mode
                // Example: /get_data?ticker=AAPL&mode=price
                document.getElementById('chart-title').innerText = currentTicker;
                
                console.log(`Fetching ${currentMode} for ${currentTicker}`);
                
                let url = `/get_data?ticker=${currentTicker}&mode=${currentMode}`;
                
                if (currentMode === 'map-2dcorr' && secondaryTicker) {
                    url += `&ticker2=${secondaryTicker}`;
                }
                
                const container = document.getElementById('price-plot-container');
                
                fetch(url)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`Server responded with ${response.status}: ${response.statusText}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        // Plotly.react updates an existing plot if it's there.
                        Plotly.react(container, data.fig_data.data, data.fig_data.layout);
                        
                        // Update Sharpe ratio
                        const sharpeRatio = document.getElementById('sharpe-ratio-display');
                        if (sharpeRatio && data.sharpe) {
                            sharpeRatio.innerText = data.sharpe;
                        }
                        
                        // Update semivariance
                        const semivariance = document.getElementById('semivariance-display');
                        if (semivariance && data.semivariance) {
                            semivariance.innerText = data.semivariance;
                        }
                        
                        // Update Sortino ratio
                        const sortinoRatio = document.getElementById('sortino-ratio-display');
                        if (sortinoRatio && data.sortino) {
                            sortinoRatio.innerText = data.sortino;
                        }
                        
                        // Update symmetry score
                        const symmetryScore = document.getElementById('symmetry-score-display');
                        if (symmetryScore && data.symmetry_score) {
                            symmetryScore.innerText = data.symmetry_score;
                        }
                        
                        // Update D'Agostino-Pearson statistics
                        const dagostino_pearson_statistics = document.getElementById('dagostino_pearson_statistics-display');
                        if (dagostino_pearson_statistics && data.dagostino_pearson_statistics) {
                            dagostino_pearson_statistics.innerText = data.dagostino_pearson_statistics;
                        }
                        
                        // Update D'Agostino-Pearson p-value
                        const dagostino_pearson_pvalue = document.getElementById('dagostino_pearson_pvalue-display');
                        if (dagostino_pearson_pvalue && data.dagostino_pearson_pvalue) {
                            dagostino_pearson_pvalue.innerText = data.dagostino_pearson_pvalue;
                        }
                        
                        // Update Jarque-Bera statistics
                        const jarque_bera_statistics = document.getElementById('jarque_bera_statistics-display');
                        if (jarque_bera_statistics && data.jarque_bera_statistics) {
                            jarque_bera_statistics.innerText = data.jarque_bera_statistics;
                        }
                        
                        // Update Jarque-Bera p-value
                        const jarque_bera_pvalue = document.getElementById('jarque_bera_pvalue-display');
                        if (jarque_bera_pvalue && data.jarque_bera_pvalue) {
                            jarque_bera_pvalue.innerText = data.jarque_bera_pvalue;
                        }
                        
                        // Update z-score max
                        const z_score_max = document.getElementById('z_score_max-display');
                        if (z_score_max && data.z_score_max) {
                            z_score_max.innerText = data.z_score_max;
                        }
                        
                        // Update z-score min
                        const z_score_min = document.getElementById('z_score_min-display');
                        if (z_score_min && data.z_score_min) {
                            z_score_min.innerText = data.z_score_min;
                        }
                        
                        // Update number of outliers
                        const len_outliers = document.getElementById('len_outliers-display');
                        if (len_outliers && data.len_outliers) {
                            len_outliers.innerText = data.len_outliers;
                        }
                    })
                    .catch(err => {
                        console.error("Plotly Error:", err);
                        container.innerHTML = '<p style="color:red;">Error loading chart.</p>';
                    });
            }

            // Tab click logic
            tabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    // Manage tab classes
                    tabs.forEach(t => t.classList.remove('active-tab'));
                    this.classList.add('active-tab');
                    
                    // Update global mode
                    currentMode = this.dataset.mode;
                    
                    // If switching to correlation, ensure there's a partner stock
                    if (currentMode === 'map-2dcorr' && !secondaryTicker) {
                        // Find the first ticker in the sidebar that isn't the current primary one
                        const firstOtherRow = [...tickerRows].find(r => r.dataset.ticker !== currentTicker);
                        if (firstOtherRow) {
                            secondaryTicker = firstOtherRow.dataset.ticker;
                        } else {
                            // Fallback if there's only one ticker in the database
                            secondaryTicker = currentTicker;
                        }
                    }
                    
                    refreshSidebarUI();
                    updateView();
                });
            });

            // Ticker click logic
            tickerRows.forEach(row => {
                row.addEventListener('click', function() {
                    const clickedTicker = this.dataset.ticker;
                    
                    if (currentMode === 'map-2dcorr') {
                        // If the user clicks a ticker that isn't the primary one, set it as the secondary (yellow) ticker.
                        if (clickedTicker === currentTicker) {
                            return;
                        }
                        secondaryTicker = clickedTicker;
                    } else {
                        // Just update the primary ticker.
                        currentTicker = clickedTicker;
                    }
                    
                    refreshSidebarUI();
                    updateView();
                });
            });
            
            function refreshSidebarUI() {
                // Update the chart title
                const titleElement = document.getElementById('chart-title');
                if (currentMode === 'map-2dcorr' && secondaryTicker) {
                    titleElement.innerText = `${currentTicker} vs ${secondaryTicker}`;
                } else {
                    titleElement.innerText = currentTicker;
                }

                // Manage highlighting and indicators for every row
                tickerRows.forEach(row => {
                    const rowTicker = row.dataset.ticker;
                    const indicator = row.querySelector('.indicator');

                    // Reset everything first
                    row.classList.remove('active-ticker', 'secondary-ticker');
                    if (indicator) indicator.innerText = '';

                    // Apply primary (blue)
                    if (rowTicker === currentTicker) {
                        row.classList.add('active-ticker');
                        if (indicator) indicator.innerText = '▶';
                    } 
                    // Apply secondary (yellow)
                    else if (currentMode === 'map-2dcorr' && rowTicker === secondaryTicker) {
                        row.classList.add('secondary-ticker');
                        if (indicator) indicator.innerText = 'II'; // Using 'II' to show it's the 2nd asset
                    }
                });
            }
            
            document.getElementById('expand-btn').addEventListener('click', function() {
                const startDate = document.getElementById('start-date').value;
                if (!startDate) {
                    alert("Please select a date first.");
                    return;
                }

                const ticker = currentTicker; // Use the global currentTicker
                const btn = this;
                const originalText = btn.innerText;
                
                btn.innerText = "Downloading...";
                btn.disabled = true;

                // Call a new Flask route
                fetch(`/expand_history?ticker=${ticker}&start=${startDate}`)
                    .then(response => response.json())
                    .then(data => {
                        alert(data.message);
                        btn.innerText = originalText;
                        btn.disabled = false;
                        // Refresh the current plot to show the new longer history
                        updateView(); 
                    })
                    .catch(err => {
                        console.error(err);
                        btn.innerText = "Error";
                        btn.disabled = false;
                    });
            });
        });
    </script>
</body>

